<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="./styles.css">
    <title>Image Gallery Creator</title>
    <script>
        const handleResponse = async (response) => {
            const responseText = await response.text();
            console.log(responseText);

            const parsedData = JSON.parse(responseText);

            let galleries = parsedData.galleries;
            let message = parsedData.message;

            const galName = document.getElementById('createdGals').value;
            const content = document.getElementById('content');

            if (galleries) {
                content.innerHTML = '';

                const galImages = galleries[`gal-${galName}`].images;

                for (let image in galImages) {
                    console.log(galImages[image]);
                    let newImg = document.createElement('img');
                    newImg.setAttribute('src', galImages[image].url);
                    newImg.setAttribute('class', 'galImage');
                    content.appendChild(newImg);
                }
            }
        };

        const getGalleries = async () => {
            const response = await fetch('/getGallery', { method: 'get'});

            handleResponse(response);
        };

        const sendGalleryPost = async (form) => {
            const url = form.getAttribute('action');
            const method = form.getAttribute('method');

            const galName = document.getElementById('galNameField').value;

            let isCreated = false;
            const createdGals = document.getElementById('createdGals');
            
            for (let option of createdGals.childNodes) {
                if (option.value == galName) { 
                    isCreated = true; 
                    break;
                }
            }

            const formData = `galName=${galName}`;

            const response = await fetch(url, {
                method,
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/x-www-form-urlenconded'
                },
                body: formData
            });

            handleResponse(response);

            if (galName == '' || isCreated){ return; }

            let newEntry = document.createElement('option');
            newEntry.setAttribute('value', galName);
            newEntry.appendChild(document.createTextNode(galName));
            createdGals.appendChild(newEntry);
        };

        const sendImagePost = async (form) => {
            const url = form.getAttribute('action');
            const method = form.getAttribute('method');

            const imgName = document.getElementById('imgNameField').value;
            const imgSource = document.getElementById('imgSourceField').value;
            const imgURL = document.getElementById('imgURLField').value;
            const galName = document.getElementById('createdGals').value;

            const formData = `imgName=${imgName}&imgSource=${imgSource}&imgURL=${imgURL}&galName=${galName}`;

            const response = await fetch(url, {
                method,
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/x-www-form-urlenconded'
                },
                body: formData
            });

            handleResponse(response);
        };

        const init = (e) => {
            const galForm = document.getElementById('galForm');
            const imgForm = document.getElementById('imgForm');
            const galBtn = document.getElementById('galBtn')

            const createGal = (e) => {
                e.preventDefault();
                sendGalleryPost(galForm);
                return false;
            };

            const addImage = (e) => {
                e.preventDefault();
                sendImagePost(imgForm);
                return false;
            };

            galForm.addEventListener('submit', createGal);
            imgForm.addEventListener('submit', addImage);
            galBtn.addEventListener('click', getGalleries);
        };

        window.onload = init;
    </script>
</head>

<body>
    <form action="/createGallery" method="post" id="galForm">
        <label for="galName">Gallery Name: </label>
        <input id="galNameField" type="text" name="galName" />
        <input type="submit" value="Add Gallery" />
    </form>

    <form action="/addImage" method="post" id="imgForm">
        <label for="imgName">Image Name: </label>
        <input id="imgNameField" type="text" name="imgName" />
        <label for="imgSource">Image Name: </label>
        <input id="imgSourceField" type="text" name="imgSource" />
        <label for="imgURL">Image URL: </label>
        <input id="imgURLField" type="text" name="imgURL" />
        <input type="submit" value="Add Image to Gallery" />
    </form>

    <select id="createdGals"></select>

    <button id="galBtn">Get Galleries</button>

    <section id="content">

    </section>
</body>
</html>